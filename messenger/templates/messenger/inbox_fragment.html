{# messenger/inbox_fragment.html #}
<div x-data="inbox()" x-init="init()" class="grid grid-cols-12 gap-4">
  <!-- üì© Liste des conversations -->
  <aside class="col-span-12 md:col-span-4 bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700 shadow-sm">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2">
        <i data-lucide="message-square" class="w-4 h-4 text-cyan-600"></i> Conversations
      </h3>
      <button @click="openNew = true"
              class="text-xs px-3 py-1 rounded bg-cyan-600 text-white hover:bg-cyan-500 transition">
        + Nouvelle
      </button>
    </div>

    <ul id="conv-list" class="space-y-1 max-h-[60vh] overflow-y-auto pr-1">
      {% for c in convs %}
      <li>
        <a href="/master/messenger/conversation/{{ c.conversation.id }}/?fragment=1"
           data-chat-link
           class="flex items-center justify-between gap-2 px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 text-sm text-slate-700 dark:text-slate-200">
          <span class="truncate">{{ c.conversation.title|default:"Sans titre" }}</span>
          <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
        </a>
      </li>
      {% empty %}
      <li class="text-slate-400 text-sm px-3 py-2">Aucune conversation.</li>
      {% endfor %}
    </ul>
  </aside>

  <!-- üí¨ Zone de chat -->
  <section id="chat-panel"
           class="col-span-12 md:col-span-8 bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700 shadow-sm">
    <div class="flex flex-col items-center justify-center text-slate-400 text-sm h-[60vh]">
      <i data-lucide="message-circle" class="w-6 h-6 mb-2"></i>
      S√©lectionnez une conversation pour commencer.
    </div>
  </section>

  <!-- ‚ûï Nouvelle conversation -->
  <div x-show="openNew" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
    <div @click.away="openNew = false"
         class="w-full max-w-xl bg-white dark:bg-slate-800 rounded-xl p-5 border border-slate-200 dark:border-slate-700 shadow-xl">
      <h4 class="text-slate-800 dark:text-slate-100 font-semibold mb-3">Nouvelle conversation</h4>
      <form @submit.prevent="createConv" class="space-y-3">
        {% csrf_token %}
        <div>
          <label class="text-sm text-slate-600 dark:text-slate-300">Titre</label>
          <input x-model="form.title" required
                 class="mt-1 w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 text-sm bg-white dark:bg-slate-900">
        </div>
        <div>
          <label class="text-sm text-slate-600 dark:text-slate-300 mb-1 block">Participants</label>
          <select id="userSelect" x-ref="userSelect" multiple size="6"
                  class="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 text-sm bg-white dark:bg-slate-900">
            {% include "messenger/_user_options.html" %}
          </select>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" @click="openNew = false" class="px-3 py-2 rounded border border-slate-300 text-sm">Annuler</button>
          <button type="submit" class="px-4 py-2 rounded bg-cyan-600 text-white hover:bg-cyan-500 text-sm">Cr√©er</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function inbox(){
  return {
    openNew:false,
    form:{title:""},
    init(){ this.wireLinks(document); },
    wireLinks(scope){
      scope.querySelectorAll('[data-chat-link]').forEach(a=>{
        a.addEventListener('click',async(e)=>{
          e.preventDefault();
          const panel=document.getElementById('chat-panel');
          panel.innerHTML="<div class='p-5 text-slate-500'>Chargement‚Ä¶</div>";
          const r=await fetch(a.href,{headers:{'X-Requested-With':'XMLHttpRequest'}});
          const html=await r.text();
          panel.innerHTML=html;
          if(window.lucide) lucide.createIcons();
        });
      });
    },
    async createConv(){
      const sel=this.$refs.userSelect;
      const ids=Array.from(sel.selectedOptions).map(o=>o.value).filter(Boolean);
      const payload={title:this.form.title,participants:ids.join(",")};
      const resp=await fetch("/master/messenger/create/",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "X-Requested-With":"XMLHttpRequest",
          "X-CSRFToken":(document.querySelector('[name=csrfmiddlewaretoken]')?.value||"")
        },
        body:JSON.stringify(payload)
      });
      const data=await resp.json();
      if(!data.ok){ alert("Erreur: "+(data.error||"inconnue")); return; }
      this.openNew=false;
      const panel=document.getElementById('chat-panel');
      const r=await fetch(data.chat_url,{headers:{'X-Requested-With':'XMLHttpRequest'}});
      panel.innerHTML=await r.text();
      if(window.lucide) lucide.createIcons();
    }
  }
}
</script>
