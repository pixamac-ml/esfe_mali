{% load static %}

<div class="space-y-6">

  <!-- üß≠ En-t√™te -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h2 class="text-xl font-semibold text-slate-800 dark:text-white flex items-center gap-2">
        <i data-lucide="file-text" class="w-5 h-5 text-cyan-600"></i>
        Devoirs
      </h2>
      <p class="text-sm text-slate-500 dark:text-slate-400">
        Travaux √† rendre, QCM et projets en cours.
      </p>
    </div>

    <button id="refresh-assignments"
      class="flex items-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-medium shadow-sm transition-all duration-150">
      <i data-lucide="refresh-cw" class="w-4 h-4"></i> Rafra√Æchir
    </button>
  </div>

  <!-- üßæ Tableau des devoirs -->
  {% if assignments_rows %}
  <div
    class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm bg-white dark:bg-slate-800">
    <table class="min-w-full text-sm table-auto">
      <thead class="bg-slate-50 dark:bg-slate-700/60">
        <tr class="text-left text-slate-700 dark:text-slate-200 font-medium">
          <th class="px-4 py-2">Cours</th>
          <th class="px-4 py-2">Titre</th>
          <th class="px-4 py-2">Type</th>
          <th class="px-4 py-2">√âch√©ance</th>
          <th class="px-4 py-2">Statut</th>
          <th class="px-4 py-2 text-center">Action</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
        {% for row in assignments_rows %}
        {% with a=row.assignment sub=row.submission %}
        <tr
          class="hover:bg-slate-50 dark:hover:bg-slate-700/40 transition-colors {% if a.close_at and now and a.close_at < now %}opacity-70{% endif %}">
          <td class="px-4 py-2 text-slate-700 dark:text-slate-200 font-medium">{{ a.module.title }}</td>
          <td class="px-4 py-2 text-slate-700 dark:text-slate-200">{{ a.title }}</td>
          <td class="px-4 py-2 text-xs text-slate-600 dark:text-slate-400">{{ a.get_kind_display }}</td>
          <td class="px-4 py-2 text-xs text-slate-600 dark:text-slate-400">
            {% if a.close_at %}
              {{ a.close_at|date:"d/m √† H:i" }}
            {% else %}
              ‚Äî
            {% endif %}
          </td>

          <!-- ‚úÖ Statut -->
          <td class="px-4 py-2">
            {% if sub %}
              {% if sub.status == "GRADED" %}
                <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium rounded-full bg-emerald-100 text-emerald-800">
                  <i data-lucide="check-circle" class="w-3 h-3"></i> Not√© ({{ sub.note_20 }}/20)
                </span>
              {% elif sub.status == "SUBMITTED" %}
                <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium rounded-full bg-sky-100 text-sky-800">
                  <i data-lucide="clock" class="w-3 h-3"></i> Soumis
                </span>
              {% elif sub.status == "LATE" %}
                <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium rounded-full bg-rose-100 text-rose-800">
                  <i data-lucide="alert-triangle" class="w-3 h-3"></i> En retard
                </span>
              {% else %}
                <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium rounded-full bg-amber-100 text-amber-800">
                  <i data-lucide="edit-3" class="w-3 h-3"></i> Brouillon
                </span>
              {% endif %}
            {% else %}
              <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium rounded-full bg-amber-100 text-amber-800">
                <i data-lucide="upload" class="w-3 h-3"></i> √Ä rendre
              </span>
            {% endif %}
          </td>

          <!-- ‚úÖ Action -->
          <td class="px-4 py-2 text-center">
            {% if sub %}
              {% if sub.status == "GRADED" %}
                <a href="#" class="text-emerald-600 hover:text-emerald-500 text-xs font-medium transition">Voir la note</a>
              {% elif sub.status == "SUBMITTED" %}
                <a href="#" class="text-slate-600 dark:text-slate-300 hover:text-cyan-500 text-xs font-medium transition">Modifier</a>
              {% else %}
                <a href="#" class="text-cyan-700 dark:text-cyan-400 hover:text-cyan-500 text-xs font-medium transition">Continuer</a>
              {% endif %}
            {% else %}
              {% if a.is_open %}
                <a href="#" class="text-cyan-700 dark:text-cyan-400 hover:text-cyan-500 text-xs font-medium transition">Commencer</a>
              {% else %}
                <span class="text-slate-400 text-xs">Ferm√©</span>
              {% endif %}
            {% endif %}
          </td>
        </tr>
        {% endwith %}
        {% empty %}
        <tr>
          <td colspan="6" class="text-center py-6 text-slate-400 dark:text-slate-500">
            Aucun devoir trouv√© pour ce semestre.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="text-sm text-slate-500 dark:text-slate-400">Aucun devoir publi√© pour le moment.</p>
  {% endif %}
</div>

<!-- ‚úÖ JS enrichi : Lucide, Preline et Refresh -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Active les ic√¥nes Lucide et composants Preline
  if (window.lucide) lucide.createIcons();
  if (window.HSStaticMethods) HSStaticMethods.autoInit();

  // üîÅ Bouton Rafra√Æchir
  const refreshBtn = document.getElementById("refresh-assignments");
  if (refreshBtn) {
    refreshBtn.addEventListener("click", (e) => {
      e.preventDefault();
      refreshBtn.classList.add("opacity-70", "pointer-events-none");
      setTimeout(() => location.reload(), 500);
    });
  }
});
</script>
