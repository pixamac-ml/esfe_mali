<!-- masters/fragments/student/overview.html -->
<div
  x-data="overviewData()"
  x-init="init()"
  class="space-y-6 fade-in"
>

  <!-- üß≠ En-t√™te bienvenue -->
  <div class="text-center space-y-1">
    <h2 class="text-2xl font-semibold text-primary-700 dark:text-primary-300">
      Bienvenue <span x-text="userName"></span> üëã
    </h2>

    <template x-if="program">
      <p class="text-sm text-slate-600 dark:text-slate-300">
        Programme :
        <strong class="font-semibold text-slate-800 dark:text-slate-100" x-text="program"></strong>
        <span class="px-2 text-slate-400">‚Ä¢</span>
        Cohorte <span class="font-medium" x-text="cohort"></span>
      </p>
    </template>
  </div>

  <!-- üìä Statistiques principales -->
  <div class="grid md:grid-cols-3 gap-4">
    <!-- Progression -->
    <div class="card bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm">
      <div class="p-5">
        <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Progression</p>
        <div class="mt-2 flex items-baseline gap-2">
          <p class="text-2xl font-bold text-primary-700 dark:text-primary-300" x-text="progress + '%'"></p>
          <span class="text-xs text-slate-400">moyenne</span>
        </div>

        <!-- Barre de progression (native Tailwind, sans daisyUI) -->
        <div class="progress mt-3">
          <div class="progress-bar rounded-full" :style="{ width: Math.min(Math.max(progress,0),100) + '%' }"></div>
        </div>

        <p class="text-xs text-slate-400 mt-2">Avancement moyen dans vos modules.</p>
      </div>
    </div>

    <!-- Moyenne g√©n√©rale -->
    <div class="card bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm">
      <div class="p-5">
        <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Moyenne g√©n√©rale</p>
        <p class="mt-2 text-2xl font-bold text-emerald-600 dark:text-emerald-300"
           x-text="average ? (average + '/20') : '‚Äî'"></p>
        <p class="text-xs text-slate-400 mt-2">Calcul√©e sur les r√©sultats disponibles.</p>
      </div>
    </div>

    <!-- Cr√©dits valid√©s -->
    <div class="card bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm">
      <div class="p-5">
        <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Cr√©dits valid√©s</p>
        <p class="mt-2 text-2xl font-bold text-indigo-600 dark:text-indigo-300" x-text="credits"></p>
        <p class="text-xs text-slate-400 mt-2">ECTS obtenus.</p>
      </div>
    </div>
  </div>

  <!-- üïì Activit√©s r√©centes -->
  <div class="card bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm">
    <div class="p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="section-title m-0">
          <i data-lucide="activity" class="w-4 h-4 text-primary-600 dark:text-primary-300"></i>
          Derni√®res activit√©s
        </h3>

        <button
          type="button"
          @click="refresh()"
          :disabled="refreshing"
          class="btn btn-outline gap-2 disabled:opacity-60 disabled:cursor-not-allowed"
          aria-label="Rafra√Æchir les activit√©s"
        >
          <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
          <span x-text="refreshing ? 'Rafra√Æchissement‚Ä¶' : 'Rafra√Æchir'"></span>
        </button>
      </div>

      <!-- Squelette quand chargement -->
      <template x-if="loading">
        <ul class="space-y-2">
          <template x-for="i in 4" :key="i">
            <li class="animate-pulse">
              <div class="h-3 w-1/3 bg-slate-200 dark:bg-slate-700 rounded mb-2"></div>
              <div class="h-2 w-1/2 bg-slate-200 dark:bg-slate-700 rounded"></div>
            </li>
          </template>
        </ul>
      </template>

      <!-- Aucune activit√© -->
      <template x-if="!loading && activities.length === 0">
        <p class="text-slate-500 text-sm">Aucune activit√© r√©cente d√©tect√©e.</p>
      </template>

      <!-- Liste d‚Äôactivit√©s -->
      <ul class="space-y-3 text-sm" x-show="!loading && activities.length">
        <template x-for="act in activities" :key="act.id">
          <li class="pb-3 border-b border-slate-200 dark:border-slate-700">
            <div class="flex items-start gap-2">
              <span class="mt-0.5 inline-flex">
                <!-- si l‚ÄôAPI ne renvoie pas d‚Äôic√¥ne HTML, on affiche une ic√¥ne type selon act.type -->
                <template x-if="!act.icon">
                  <i :data-lucide="iconFor(act.type)" class="w-4 h-4 text-primary-600 dark:text-primary-300"></i>
                </template>
                <span x-show="act.icon" x-html="act.icon"></span>
              </span>

              <div class="min-w-0">
                <p class="font-medium text-slate-800 dark:text-slate-100">
                  <span x-text="act.title"></span>
                </p>
                <p class="text-slate-500 dark:text-slate-400" x-text="act.detail"></p>
                <span class="block text-xs text-slate-400 mt-0.5" x-text="act.date"></span>
              </div>
            </div>
          </li>
        </template>
      </ul>

      <!-- Message d‚Äôerreur -->
      <p x-show="error" class="mt-3 text-sm text-red-600 dark:text-red-400">
        <strong>Erreur :</strong> <span x-text="error"></span>
      </p>
    </div>
  </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('overviewData', () => ({
    // ---- state
    userName: "{{ user.first_name|default:'√âtudiant' }}",
    program: "{{ enrollment.program.title|default:'' }}",
    cohort: "{{ enrollment.cohort.label|default:'' }}",
    progress: 0,
    average: 0,
    credits: 0,
    activities: [],
    loading: true,
    refreshing: false,
    error: '',

    // ---- lifecycle
    init() {
      this.loadStats();
    },

    // ---- helpers
    iconFor(type) {
      // mapping minimal : course | assignment | exam | message | result | default
      const map = {
        course: 'book-open',
        assignment: 'file-text',
        exam: 'clipboard-list',
        message: 'mail',
        result: 'bar-chart-3'
      };
      return map[type] || 'activity';
    },

    // ---- actions
    async loadStats() {
      this.loading = true;
      this.error = '';
      try {
        const res = await fetch("{% url 'masters:api_student_overview' %}", {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (data && data.ok) {
          this.progress   = Number(data.progress ?? 0);
          this.average    = Number(data.average ?? 0);
          this.credits    = Number(data.credits ?? 0);
          this.activities = Array.isArray(data.activities) ? data.activities : [];
        } else {
          throw new Error(data?.message || "R√©ponse invalide");
        }
      } catch (err) {
        console.error('Erreur chargement overview:', err);
        this.error = "Impossible de charger les donn√©es. R√©essayez.";
      } finally {
        this.loading = false;
        // Re-init ic√¥nes + Preline apr√®s DOM update
        queueMicrotask(() => {
          if (window.lucide) lucide.createIcons();
          if (window.HSStaticMethods) HSStaticMethods.autoInit();
        });
      }
    },

    async refresh() {
      if (this.refreshing) return;
      this.refreshing = true;
      await this.loadStats();
      // petit d√©lai visuel pour √©viter spam
      setTimeout(() => { this.refreshing = false; }, 400);
    }
  }));
});
</script>
