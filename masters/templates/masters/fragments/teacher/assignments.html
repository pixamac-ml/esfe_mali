{% load static %}

<div
  id="teacherAssignments"
  x-data="assignmentManager()"
  x-init="loadAssignments()"
  class="space-y-8 animate-fadeIn"
>

  <!-- ðŸ§­ En-tÃªte -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h2 class="text-2xl font-semibold text-slate-800 dark:text-white flex items-center gap-2">
        <i data-lucide="file-text" class="w-6 h-6 text-cyan-600"></i>
        Mes devoirs
      </h2>
      <p class="text-sm text-slate-500 dark:text-slate-400">
        CrÃ©ez, gÃ©rez et suivez vos devoirs par module.
      </p>
    </div>

    <button
      @click="formOpen = !formOpen"
      class="flex items-center gap-2 px-3 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg text-sm font-medium shadow transition"
    >
      <i data-lucide="plus-circle" class="w-4 h-4"></i>
      <span x-text="formOpen ? 'Fermer' : 'Nouveau devoir'"></span>
    </button>
  </div>

  <!-- ðŸ§¾ Liste des devoirs -->
  <div
    class="overflow-x-auto rounded-xl shadow bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700"
  >
    <table class="w-full text-sm text-left">
      <thead class="bg-slate-100 dark:bg-slate-700/50 text-slate-700 dark:text-slate-300 uppercase text-xs">
        <tr>
          <th class="px-4 py-3">Titre</th>
          <th class="px-4 py-3 text-center">Module</th>
          <th class="px-4 py-3 text-center">Remises</th>
          <th class="px-4 py-3 text-center">Date limite</th>
          <th class="px-4 py-3 text-center">Statut</th>
        </tr>
      </thead>
      <tbody>
        <template x-if="assignments.length === 0">
          <tr>
            <td colspan="5" class="py-8 text-center text-slate-500 dark:text-slate-400">
              <i data-lucide="loader" class="inline w-4 h-4 animate-spin text-cyan-600"></i>
              Chargement des devoirs...
            </td>
          </tr>
        </template>

        <template x-for="a in assignments" :key="a.id">
          <tr
            class="hover:bg-slate-50 dark:hover:bg-slate-700/50 border-b border-slate-100 dark:border-slate-700 transition"
          >
            <td class="px-4 py-2 font-medium text-slate-800 dark:text-slate-100" x-text="a.title"></td>
            <td class="px-4 py-2 text-center text-slate-600 dark:text-slate-300" x-text="a.module"></td>
            <td class="px-4 py-2 text-center">
              <span x-text="a.submitted + '/' + a.total"></span>
            </td>
            <td class="px-4 py-2 text-center" x-text="a.deadline"></td>
            <td class="px-4 py-2 text-center">
              <span
                class="px-2 py-0.5 rounded-full text-xs font-semibold"
                :class="a.active ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-700/30 dark:text-emerald-300' : 'bg-rose-100 text-rose-700 dark:bg-rose-700/30 dark:text-rose-300'"
                x-text="a.active ? 'Actif' : 'ClÃ´turÃ©'"
              ></span>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>

  <!-- ðŸ“„ Formulaire de crÃ©ation -->
  <div
    x-show="formOpen"
    x-transition
    class="card bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-inner p-6 space-y-4 rounded-xl"
  >
    <h3 class="text-lg font-semibold text-slate-800 dark:text-white flex items-center gap-2">
      <i data-lucide="edit-3" class="w-5 h-5 text-cyan-600"></i>
      Nouveau devoir
    </h3>

    <div class="grid sm:grid-cols-2 gap-4">
      <div class="form-control">
        <label class="label text-sm text-slate-600 dark:text-slate-400">Titre</label>
        <input
          x-model="form.title"
          type="text"
          placeholder="Titre du devoir"
          class="input input-bordered w-full bg-white dark:bg-slate-900"
        />
      </div>

      <div class="form-control">
        <label class="label text-sm text-slate-600 dark:text-slate-400">Module</label>
        <select
          x-model="form.module_id"
          class="select select-bordered w-full bg-white dark:bg-slate-900"
        >
          <option value="">â€” SÃ©lectionnez un module â€”</option>
          <template x-for="m in modules" :key="m.id">
            <option :value="m.id" x-text="m.title"></option>
          </template>
        </select>
      </div>

      <div class="form-control sm:col-span-2">
        <label class="label text-sm text-slate-600 dark:text-slate-400">Date limite</label>
        <input
          x-model="form.deadline"
          type="date"
          class="input input-bordered w-full bg-white dark:bg-slate-900"
        />
      </div>
    </div>

    <div class="flex justify-end gap-2 pt-2">
      <button
        @click="formOpen = false"
        class="btn btn-ghost btn-sm text-slate-600 dark:text-slate-300"
      >
        Annuler
      </button>
      <button
        @click="submitAssignment()"
        class="btn btn-success btn-sm flex items-center gap-2"
      >
        <i data-lucide="save" class="w-4 h-4"></i> Enregistrer
      </button>
    </div>
  </div>

</div>

<!-- === SCRIPT Alpine.js === -->
<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('assignmentManager', () => ({
    assignments: [],
    modules: [],
    formOpen: false,
    form: { title: '', module_id: '', deadline: '' },

    async loadAssignments() {
      try {
        const res = await fetch("/master/api/teacher/modules/", {
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });
        const data = await res.json();
        this.modules = data.modules || [];

        // Simule les devoirs liÃ©s aux modules (exemple visuel)
        this.assignments = this.modules.map(m => ({
          id: m.id,
          title: "Devoir sur " + m.title,
          module: m.title,
          submitted: Math.floor(Math.random() * 25),
          total: Math.floor(Math.random() * 30) + 10,
          deadline: new Date().toLocaleDateString(),
          active: Math.random() > 0.3,
        }));

        if (window.lucide) lucide.createIcons();
      } catch (e) {
        console.error(e);
        this.assignments = [];
      }
    },

    async submitAssignment() {
      if (!this.form.title || !this.form.module_id || !this.form.deadline) {
        this.$dispatch('toast', { type: 'error', message: 'Veuillez remplir tous les champs.' });
        return;
      }

      try {
        const res = await fetch("/master/api/create-assignment/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest"
          },
          body: JSON.stringify(this.form)
        });
        const json = await res.json();
        this.$dispatch('toast', { type: 'success', message: json.message || 'Devoir enregistrÃ© !' });
        this.form = { title: '', module_id: '', deadline: '' };
        this.formOpen = false;
        this.loadAssignments();
      } catch (err) {
        console.error(err);
        this.$dispatch('toast', { type: 'error', message: 'Erreur lors de lâ€™enregistrement.' });
      }
    },
  }));
});
</script>

<!-- === STYLES Dâ€™ANIMATION === -->
<style>
  .animate-fadeIn {
    animation: fadeIn 0.3s ease-out;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: none; }
  }
</style>
