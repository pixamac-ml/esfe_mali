{% load static %}

<div id="teacher-overview" class="space-y-8 animate-fadeIn">

  <!-- üß≠ En-t√™te -->
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-semibold text-slate-800 dark:text-white flex items-center gap-2">
        <i data-lucide="home" class="w-6 h-6 text-cyan-600"></i>
        Aper√ßu g√©n√©ral
      </h2>
      <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
        Bienvenue <strong>{{ user.first_name|default:user.username }}</strong>, voici un r√©sum√© de votre activit√©.
      </p>
    </div>
    <button id="refreshOverview"
      class="btn btn-sm bg-cyan-600 hover:bg-cyan-500 text-white shadow-sm transition flex items-center gap-2">
      <i data-lucide="refresh-cw" class="w-4 h-4"></i> Rafra√Æchir
    </button>
  </div>

  <!-- üìä Statistiques cl√©s -->
  <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-5">
    <div class="stat-card">
      <div class="stat-icon bg-cyan-100 text-cyan-600"><i data-lucide="book-open"></i></div>
      <div><p class="stat-label">Cours actifs</p><p class="stat-value" id="statCourses">‚Äî</p></div>
    </div>

    <div class="stat-card">
      <div class="stat-icon bg-orange-100 text-orange-600"><i data-lucide="file-text"></i></div>
      <div><p class="stat-label">Devoirs √† corriger</p><p class="stat-value" id="statAssignments">‚Äî</p></div>
    </div>

    <div class="stat-card">
      <div class="stat-icon bg-emerald-100 text-emerald-600"><i data-lucide="users"></i></div>
      <div><p class="stat-label">√âtudiants suivis</p><p class="stat-value" id="statStudents">‚Äî</p></div>
    </div>

    <div class="stat-card">
      <div class="stat-icon bg-violet-100 text-violet-600"><i data-lucide="activity"></i></div>
      <div><p class="stat-label">Taux de progression</p><p class="stat-value" id="statProgress">‚Äî%</p></div>
    </div>
  </div>

  <!-- üîî Notifications -->
  <div class="card bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm">
    <div class="card-body space-y-3">
      <h3 class="card-title flex items-center gap-2 text-lg font-semibold text-slate-800 dark:text-white">
        <i data-lucide="bell" class="w-5 h-5 text-cyan-600"></i> Derni√®res notifications
      </h3>
      <ul id="notificationsList" class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
        <li class="text-slate-400 italic">Chargement des notifications...</li>
      </ul>
    </div>
  </div>

  <!-- üßæ Examens & Devoirs r√©cents -->
  <div class="grid lg:grid-cols-2 gap-6">
    <!-- Examens -->
    <div class="card bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm">
      <div class="card-body">
        <h3 class="card-title flex items-center gap-2 text-lg font-semibold text-slate-800 dark:text-white mb-2">
          <i data-lucide="clipboard-list" class="w-5 h-5 text-cyan-600"></i> Examens √† venir
        </h3>
        <ul id="upcomingExams" class="space-y-2 text-sm">
          <li class="text-slate-400 italic">Chargement...</li>
        </ul>
      </div>
    </div>

    <!-- Devoirs -->
    <div class="card bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm">
      <div class="card-body">
        <h3 class="card-title flex items-center gap-2 text-lg font-semibold text-slate-800 dark:text-white mb-2">
          <i data-lucide="file-text" class="w-5 h-5 text-orange-500"></i> Derniers devoirs re√ßus
        </h3>
        <ul id="recentAssignments" class="space-y-2 text-sm">
          <li class="text-slate-400 italic">Chargement...</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- === STYLES & SCRIPT restent identiques √† la version pr√©c√©dente === -->

<!-- === STYLES === -->
<style>
  .animate-fadeIn { animation: fadeIn .3s ease-out; }
  @keyframes fadeIn { from {opacity:0;transform:translateY(6px);} to {opacity:1;transform:none;} }

  .stat-card {
    display:flex;align-items:center;gap:0.75rem;
    background-color:white;border-radius:0.75rem;padding:1rem;
    border:1px solid rgb(226 232 240);
  }
  .dark .stat-card { background-color:rgb(30 41 59); border-color:rgb(51 65 85); }
  .stat-icon {
    width:2.75rem;height:2.75rem;display:flex;align-items:center;justify-content:center;
    border-radius:9999px;flex-shrink:0;
  }
  .stat-label { font-size:0.875rem;color:#64748b; }
  .dark .stat-label { color:#94a3b8; }
  .stat-value { font-size:1.5rem;font-weight:700;color:#0f172a; }
  .dark .stat-value { color:white; }
</style>

<!-- === SCRIPT === -->
<script>
(async function(){
  const el = {
    courses: document.getElementById("statCourses"),
    assignments: document.getElementById("statAssignments"),
    students: document.getElementById("statStudents"),
    progress: document.getElementById("statProgress"),
    notif: document.getElementById("notificationsList"),
    exams: document.getElementById("upcomingExams"),
    recents: document.getElementById("recentAssignments"),
    refresh: document.getElementById("refreshOverview"),
  };

  async function fetchStats(){
    const res = await fetch("/master/api/teacher/overview/", {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });
    if(!res.ok) throw new Error("Erreur r√©seau");
    return await res.json();
  }

  async function updateOverview(){
    try{
      const data = await fetchStats();

      el.courses.textContent = data.courses || 0;
      el.assignments.textContent = data.assignments || 0;
      el.students.textContent = data.students || 0;
      el.progress.textContent = (data.progress || 0) + "%";

      el.notif.innerHTML = data.notifications?.length
        ? data.notifications.map(n => `<li>üîî ${n}</li>`).join("")
        : `<li class="text-slate-400 italic">Aucune notification r√©cente.</li>`;

      el.exams.innerHTML = data.exams?.length
        ? data.exams.map(e => `<li>üìò <strong>${e.title}</strong> ‚Äî ${e.date}</li>`).join("")
        : `<li class="text-slate-400 italic">Aucun examen pr√©vu.</li>`;

      el.recents.innerHTML = data.recent_assignments?.length
        ? data.recent_assignments.map(a => `<li>üßæ <strong>${a.title}</strong> (${a.course})</li>`).join("")
        : `<li class="text-slate-400 italic">Aucun devoir r√©cent.</li>`;

      // ‚úÖ Toast de confirmation
      const ui = document.querySelector('html').__x?.$data;
      ui?.showToast?.('Aper√ßu mis √† jour avec succ√®s ‚úÖ', 'success');
    }catch(e){
      console.error("Erreur de chargement :", e);
      el.notif.innerHTML = `<li class="text-red-500">Erreur de chargement des donn√©es.</li>`;
      const ui = document.querySelector('html').__x?.$data;
      ui?.showToast?.('Erreur de chargement de l‚Äôaper√ßu ‚ùå', 'error');
    }
    if(window.lucide) lucide.createIcons();
  }

  el.refresh.addEventListener("click", updateOverview);
  await updateOverview();
})();
</script>
