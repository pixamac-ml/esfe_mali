{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}Tableau de bord Enseignant | ESF√© Mali{% endblock %}
{% block header_title %}Espace Enseignant Master{% endblock %}

{% block sidebar %}
<ul id="sidebar-links" class="space-y-1 text-sm font-medium">
  <li>
    <a data-section="overview" class="active-link cursor-pointer flex items-center gap-2">
      <i data-lucide="home" class="w-5 h-5"></i> <span>Aper√ßu</span>
    </a>
  </li>

  <li>
    <a data-section="teaching" class="cursor-pointer flex items-center gap-2">
      <i data-lucide="book-open" class="w-5 h-5"></i> <span>Mes enseignements</span>
    </a>
  </li>

  <li>
    <a data-section="assignments" class="cursor-pointer flex items-center gap-2">
      <i data-lucide="file-text" class="w-5 h-5"></i> <span>Devoirs</span>
    </a>
  </li>

  <li>
    <a data-section="exams" class="cursor-pointer flex items-center gap-2">
      <i data-lucide="clipboard-list" class="w-5 h-5"></i> <span>Examens</span>
    </a>
  </li>

  <li>
    <a data-section="results" class="cursor-pointer flex items-center gap-2">
      <i data-lucide="bar-chart-3" class="w-5 h-5"></i> <span>R√©sultats</span>
    </a>
  </li>

  <!-- üí¨ Messagerie interne -->
  <li>
    <a data-section="messenger" class="cursor-pointer flex items-center gap-2">
      <i data-lucide="message-circle" class="w-5 h-5"></i> <span>Messagerie interne</span>
    </a>
  </li>

  <li>
    <a data-section="settings" class="cursor-pointer flex items-center gap-2">
      <i data-lucide="settings" class="w-5 h-5"></i> <span>Param√®tres</span>
    </a>
  </li>

  <li class="border-t border-slate-200 my-2"></li>

  <li>
    <a id="nav-course-space" class="cursor-pointer flex items-center gap-2">
      <i data-lucide="video" class="w-5 h-5"></i> <span>Cours en ligne</span>
    </a>
  </li>

  <li>
    <a data-section="content" class="cursor-pointer flex items-center gap-2">
      <i data-lucide="layers" class="w-5 h-5"></i> <span>Gestion des cours</span>
    </a>
  </li>
</ul>

<style>
  #sidebar-links a {
    display:flex;align-items:center;gap:.6rem;padding:.5rem .75rem;
    border-radius:.6rem;color:#334155;transition:.25s ease;
  }
  #sidebar-links a:hover { background:#ecfeff;color:#0891b2; }
  #sidebar-links a.active-link {
    background:#cffafe;color:#164e63;font-weight:600;
    box-shadow:inset 2px 0 0 #0891b2;
  }
  .dark #sidebar-links a:hover { background:#0f172a;color:#22d3ee; }
  .dark #sidebar-links a.active-link { background:#164e63;color:#67e8f9; }
</style>
{% endblock %}


{% block dashboard_content %}
<section class="mb-5 flex items-center justify-between bg-white dark:bg-slate-800 rounded-xl p-4 shadow-sm">
  <div>
    <h2 class="text-xl font-semibold text-slate-800 dark:text-white flex items-center gap-2">
      <i data-lucide="user" class="w-5 h-5 text-cyan-600"></i> Bienvenue
    </h2>
    <p class="text-sm text-slate-500 dark:text-slate-400">Tableau de bord enseignant</p>
  </div>
  <button id="refresh-section"
          class="px-3 py-2 bg-cyan-600 text-white rounded flex items-center gap-2 hover:bg-cyan-500 transition-all shadow">
    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Rafra√Æchir
  </button>
</section>

<div id="teacher-dashboard-content"
     class="rounded-xl border border-slate-200 dark:border-slate-700 p-5 bg-white dark:bg-slate-800 relative min-h-[60vh] shadow-sm overflow-hidden">

  <!-- Loader -->
  <div id="spinner"
       class="hidden absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-900/80 z-10 backdrop-blur-sm">
    <div class="flex flex-col items-center gap-2 text-slate-600 dark:text-slate-300 text-sm">
      <span class="loading loading-ring loading-md text-cyan-600"></span>
      <span>Chargement...</span>
    </div>
  </div>

  <div id="dashboard-inner" class="text-center text-slate-500 py-8">
    Chargement en cours‚Ä¶
  </div>
</div>

<script>
(function(){
  const container   = document.getElementById("dashboard-inner");
  const spinner     = document.getElementById("spinner");
  const nav         = document.getElementById("sidebar-links");
  const btnRefresh  = document.getElementById("refresh-section");
  const courseSpace = document.getElementById("nav-course-space");

  // üîÅ R√©arme les <script> internes apr√®s chaque rendu AJAX
  function rearmScripts(scopeEl){
    scopeEl.querySelectorAll("script").forEach(old=>{
      const s=document.createElement("script");
      if(old.src) s.src=old.src;
      else s.textContent=old.textContent;
      document.body.appendChild(s);
      old.remove();
    });
  }

  // ‚ö° Charge une vue par AJAX
  async function loadView(url){
    spinner.classList.remove("hidden");
    try{
      const resp = await fetch(url, {headers: {"X-Requested-With": "XMLHttpRequest"}});
      if(!resp.ok) throw new Error("Erreur "+resp.status);
      const html = await resp.text();
      container.innerHTML = html;
      if(window.lucide) lucide.createIcons();
      rearmScripts(container);
    }catch(e){
      console.error(e);
      container.innerHTML = "<div class='text-red-600 font-medium p-4'>‚ö†Ô∏è Erreur de chargement.</div>";
      const ui = document.querySelector('html').__x?.$data;
      ui?.showToast?.('Erreur de chargement du contenu', 'error');
    }finally{
      spinner.classList.add("hidden");
    }
  }

  // üß≠ Navigation lat√©rale
  nav.addEventListener("click",(e)=>{
    const a=e.target.closest("[data-section]");
    if(!a) return;
    e.preventDefault();
    nav.querySelectorAll("a").forEach(x=>x.classList.remove("active-link"));
    a.classList.add("active-link");

    // üí¨ Cas sp√©cial : Messagerie interne
    if(a.dataset.section === "messenger"){
        loadView("/master/messenger/?fragment=1");
        return;
    }

    // Autres sections du tableau de bord
    loadView(`/master/teacher/fragment/${a.dataset.section}/`);
  });

  // üé• Section "Cours en ligne"
  courseSpace.addEventListener("click",(e)=>{
    e.preventDefault();
    nav.querySelectorAll("a").forEach(x=>x.classList.remove("active-link"));
    courseSpace.classList.add("active-link");
    loadView(`/master/teacher/fragment/courses/`);
  });

  // üéì Ouvrir un cours depuis la liste
  window.openCourseFromList = function(moduleId, title){
    nav.querySelectorAll("a").forEach(x=>x.classList.remove("active-link"));
    courseSpace.classList.add("active-link");
    setTimeout(()=>loadView(
      `/master/teacher/fragment/courses/?module_id=${encodeURIComponent(moduleId)}&title=${encodeURIComponent(title)}`
    ),200);
  };

  // ‚ñ∂Ô∏è Jouer une le√ßon
  window.openLessonPlayer = function(title, src){
    loadView(`/master/teacher/fragment/courses/?player=1&title=${encodeURIComponent(title)}&src=${encodeURIComponent(src)}`);
  };

  // üîÑ Rafra√Æchir la section active
  btnRefresh.addEventListener("click",()=>{
    const current = document.querySelector("#sidebar-links a.active-link")?.dataset.section || "overview";
    if(current==="messenger"){
      loadView("/master/messenger/?fragment=1");
    }else{
      loadView(`/master/teacher/fragment/${current}/`);
    }
  });

  // üöÄ Chargement initial
  loadView(`/master/teacher/fragment/overview/`);
})();
</script>
{% endblock %}
